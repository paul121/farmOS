<?php

/**
 * @file
 * Farm Inventory module.
 */

use Drupal\Core\Entity\EntityTypeInterface;
use Drupal\Core\Form\FormStateInterface;

/**
 * Implements hook_entity_base_field_info().
 */
function farm_inventory_entity_base_field_info(EntityTypeInterface $entity_type) {
  module_load_include('inc', 'farm_inventory', 'farm_inventory.base_fields');
  switch ($entity_type->id()) {

    // Build asset base fields.
    case 'asset':
      return farm_inventory_asset_base_fields();

    // Build quantity base fields.
    case 'quantity':
      return farm_inventory_quantity_base_fields();

    default:
      return [];
  }
}

/**
 * Implements hook_inline_entity_form_entity_form_alter().
 */
function farm_inventory_inline_entity_form_entity_form_alter(array &$entity_form, FormStateInterface &$form_state) {

  // Bail if not a quantity inline entity form.
  if ($entity_form['#entity_type'] !== 'quantity') {
    return;
  }

  // Set the inventory_adjustment default value to N/A unless already provided.
  if (empty($entity_form['inventory_adjustment']['widget']['#default_value'])) {
    $entity_form['inventory_adjustment']['widget']['#default_value'] = '_none';
  }

  // Build a selector for the inventory adjustment input.
  // This is complicated because the input name depends on the delta value,
  // and whether or not it is an existing entity in the inline entity form.
  $parents = $entity_form['#parents'];
  $adjustment_identifier = $parents[0] . '[' . implode('][', array_slice($parents, 1)) . '][inventory_adjustment]';
  $inventory_adjustment_selector = ":input[name=\"$adjustment_identifier\"]";

  // Hide the inventory asset selector until an adjustment is selected.
  $entity_form['inventory_asset']['#states']['invisible'] = [
    $inventory_adjustment_selector => ['value' => '_none'],
  ];
}
